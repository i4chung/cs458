#!/bin/bash

baseUrl=$1

# 1a) login
curl -X POST $baseUrl/post.php \
  -d "username=mallory&password=MyPassword&form=login" \
  -c cookie.txt -v 2> >(grep "<" > response.txt) 


# 1b) article
curl -X POST $baseUrl/post.php \
  -d "title=Hello&content=World&type=1&form=content" \
  -b cookie.txt -v 2> >(grep "<" >> response.txt) 

# extract top post ID
articleIdx=$(curl -X GET $baseUrl/index.php -v 2> >(grep "<" >> response.txt) | grep -oE "view\.php\?id=[0-9]*" | head -n 1 | grep -oE "[0-9]*")

# 1c) comment
curl -X POST $baseUrl/post.php \
  -d "comment=HelloComment!&form=comment&parent=$articleIdx" \
  -b cookie.txt -v 2> >(grep "<" >> response.txt) 

# # 1d) upvote
curl -X GET "$baseUrl/vote.php?id=$articleIdx&vote=1"\
  -b cookie.txt -v 2> >(grep "<" >> response.txt) 
